---
- name: Check if auth file exists
  ansible.builtin.stat:
    path: "{{ redis_registry_auth_file }}"
  register: redis_auth_file_stat
  when: redis_registry_auth_file is defined and redis_registry_auth_file | length > 0

- name: Set auth file variable if exists
  ansible.builtin.set_fact:
    redis_auth_file: "{{ redis_registry_auth_file }}"
  when: redis_registry_auth_file is defined and redis_auth_file_stat.stat.exists | default(false)

- name: Pull Redis container image
  containers.podman.podman_image:
    name: "{{ redis_container_image }}:{{ redis_container_tag }}"
    state: present
    auth_file: "{{ redis_auth_file | default(omit) }}"

- name: Create directory for Redis data
  ansible.builtin.file:
    path: /var/lib/redis
    state: directory
    owner: 1001
    group: 1001
    mode: '0755'

- name: Run Redis as a container
  containers.podman.podman_container:
    name: redis
    image: "{{ redis_container_image }}:{{ redis_container_tag }}"
    state: quadlet
    sdnotify: true
    command: ["run-redis", "--supervised", "systemd"]
    volumes:
      - /var/lib/redis:/data:Z
    ports:
      - "6379:6379"
    env:
      REGISTRY_AUTH_FILE: "{{ redis_auth_file | default(omit) }}"
    quadlet_options:
      - |
        [Install]
        WantedBy=default.target

- name: Run daemon reload
  ansible.builtin.systemd:
    daemon_reload: true

- name: Start the Redis Service
  ansible.builtin.systemd:
    name: redis
    enabled: true
    state: started
