---
- name: 'Create server key'
  ansible.builtin.command: >
    openssl genrsa
      -out "{{ certificates_ca_directory_keys }}/{{ certificates_hostname }}.key"
      4096
  args:
    creates: "{{ certificates_ca_directory_keys }}/{{ certificates_hostname }}.key"

- name: 'Set server key ownership and permissions'
  ansible.builtin.file:
    path: "{{ certificates_ca_directory_keys }}/{{ certificates_hostname }}.key"
    owner: "{{ foremanctl_user }}"
    group: "{{ foremanctl_group }}"
    mode: '0600'

- name: 'Creating server signing request'
  ansible.builtin.command: >
    openssl req
      -new
      -config "{{ certificates_ca_directory }}/openssl.cnf"
      -key "{{ certificates_ca_directory_keys }}/{{ certificates_hostname }}.key"
      -subj "/CN={{ certificates_hostname }}"
      -addext "subjectAltName = DNS:{{ certificates_hostname }}"
      -out "{{ certificates_ca_directory_requests }}/{{ certificates_hostname }}.csr"
  args:
    creates: "{{ certificates_ca_directory_requests }}/{{ certificates_hostname }}.csr"

- name: 'Set server CSR ownership and permissions'
  ansible.builtin.file:
    path: "{{ certificates_ca_directory_requests }}/{{ certificates_hostname }}.csr"
    owner: "{{ foremanctl_user }}"
    group: "{{ foremanctl_group }}"
    mode: '0644'

- name: 'Sign server signing request'
  ansible.builtin.command: >
    openssl ca
      -create_serial
      -batch
      -extensions ssl_server
      -config "{{ certificates_ca_directory }}/openssl.cnf"
      -passin "file:{{ certificates_ca_directory_keys }}/ca.pwd"
      -in "{{ certificates_ca_directory_requests }}/{{ certificates_hostname }}.csr"
      -out "{{ certificates_ca_directory_certs }}/{{ certificates_hostname }}.crt"
  args:
    creates: "{{ certificates_ca_directory_certs }}/{{ certificates_hostname }}.crt"

- name: 'Set server certificate ownership and permissions'
  ansible.builtin.file:
    path: "{{ certificates_ca_directory_certs }}/{{ certificates_hostname }}.crt"
    owner: "{{ foremanctl_user }}"
    group: "{{ foremanctl_group }}"
    mode: '0644'

- name: 'Create client key'
  ansible.builtin.command: >
    openssl genrsa
      -out "{{ certificates_ca_directory_keys }}/{{ certificates_hostname }}-client.key"
      4096
  args:
    creates: "{{ certificates_ca_directory_keys }}/{{ certificates_hostname }}-client.key"

- name: 'Set client key ownership and permissions'
  ansible.builtin.file:
    path: "{{ certificates_ca_directory_keys }}/{{ certificates_hostname }}-client.key"
    owner: "{{ foremanctl_user }}"
    group: "{{ foremanctl_group }}"
    mode: '0600'

- name: 'Creating client signing request'
  ansible.builtin.command: >
    openssl req
      -new
      -config "{{ certificates_ca_directory }}/openssl.cnf"
      -key "{{ certificates_ca_directory_keys }}/{{ certificates_hostname }}-client.key"
      -addext "subjectAltName = DNS:{{ certificates_hostname }}"
      -subj "/CN={{ certificates_hostname }}"
      -out "{{ certificates_ca_directory_requests }}/{{ certificates_hostname }}-client.csr"
  args:
    creates: "{{ certificates_ca_directory_requests }}/{{ certificates_hostname }}-client.csr"

- name: 'Set client CSR ownership and permissions'
  ansible.builtin.file:
    path: "{{ certificates_ca_directory_requests }}/{{ certificates_hostname }}-client.csr"
    owner: "{{ foremanctl_user }}"
    group: "{{ foremanctl_group }}"
    mode: '0644'

- name: 'Sign client signing request'
  ansible.builtin.command: >
    openssl ca
      -create_serial
      -batch
      -extensions ssl_client
      -config "{{ certificates_ca_directory }}/openssl.cnf"
      -passin "file:{{ certificates_ca_directory_keys }}/ca.pwd"
      -in "{{ certificates_ca_directory_requests }}/{{ certificates_hostname }}-client.csr"
      -out "{{ certificates_ca_directory_certs }}/{{ certificates_hostname }}-client.crt"
  args:
    creates: "{{ certificates_ca_directory_certs }}/{{ certificates_hostname }}-client.crt"

- name: 'Set client certificate ownership and permissions'
  ansible.builtin.file:
    path: "{{ certificates_ca_directory_certs }}/{{ certificates_hostname }}-client.crt"
    owner: "{{ foremanctl_user }}"
    group: "{{ foremanctl_group }}"
    mode: '0644'
