---
- name: Install Apache httpd
  ansible.builtin.package:
    name:
      - httpd
      - mod_ssl
    state: present

- name: Set httpd_can_network_connect so Apache can connect to Puma and Gunicorn
  ansible.posix.seboolean:
    name: httpd_can_network_connect
    state: true
    persistent: true
  when: ansible_facts['selinux']['status'] == "enabled"

- name: Disable welcome page
  ansible.builtin.file:
    path: /etc/httpd/conf.d/welcome.conf
    state: absent

- name: Create cert directories
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    mode: "0750"
  loop:
    - "{{ httpd_ssl_dir }}/certs"
    - "{{ httpd_ssl_dir }}/private"

- name: Create pub directory
  ansible.builtin.file:
    path: "{{ httpd_pub_dir }}"
    state: directory
    group: apache
    owner: apache
    mode: "0755"

- name: Deploy certificates
  ansible.builtin.copy:
    src: "{{ item.src }}"
    dest: "{{ httpd_ssl_dir }}/{{ item.dest }}"
    remote_src: true
    mode: "0640"
  loop:
    - src: "{{ httpd_server_ca_certificate }}"
      dest: "certs/katello-server-ca.crt"
    - src: "{{ httpd_client_ca_certificate }}"
      dest: "certs/katello-default-ca.crt"
    - src: "{{ httpd_server_certificate }}"
      dest: "certs/katello-apache.crt"
    - src: "{{ httpd_server_key }}"
      dest: "private/katello-apache.key"

- name: Copy CA certificate to pub directory for client trust
  ansible.builtin.copy:
    src: "{{ httpd_server_ca_certificate }}"
    dest: "{{ httpd_pub_dir }}/katello-server-ca.crt"
    remote_src: true
    mode: "0644"

- name: Configure external authentication
  ansible.builtin.include_tasks: "external_auth/{{ httpd_external_authentication }}.yml"
  when: httpd_external_authentication in ['ipa', 'ipa_with_api']

- name: Remove external authentication configuration if not enabled
  ansible.builtin.include_tasks: external_auth/cleanup.yml
  when: httpd_external_authentication is none

- name: Configure foreman vhost
  ansible.builtin.template:
    src: foreman-vhost.conf.j2
    dest: /etc/httpd/conf.d/foreman.conf
    mode: "0644"
  notify:
    - Restart httpd

- name: Configure foreman-ssl vhost
  ansible.builtin.template:
    src: foreman-ssl-vhost.conf.j2
    dest: /etc/httpd/conf.d/foreman-ssl.conf
    mode: "0644"
  notify:
    - Restart httpd

- name: Flush handlers to restart services
  ansible.builtin.meta: flush_handlers

- name: Start Apache httpd
  ansible.builtin.service:
    name: httpd
    state: started
    enabled: true
