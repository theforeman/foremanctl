---
- name: Check if auth file exists
  ansible.builtin.stat:
    path: "{{ postgresql_registry_auth_file }}"
  register: postgresql_auth_file_stat
  when: postgresql_registry_auth_file is defined and postgresql_registry_auth_file | length > 0

- name: Set auth file variable if exists
  ansible.builtin.set_fact:
    postgresql_auth_file: "{{ postgresql_registry_auth_file }}"
  when: postgresql_registry_auth_file is defined and postgresql_auth_file_stat.stat.exists | default(false)

- name: Pull PostgreSQL container image
  containers.podman.podman_image:
    name: "{{ postgresql_container_image }}:{{ postgresql_container_tag }}"
    state: present
    auth_file: "{{ postgresql_auth_file | default(omit) }}"

- name: Create PostgreSQL storage directory
  ansible.builtin.file:
    path: "{{ postgresql_data_dir }}"
    state: directory
    mode: "0700"
    owner: 26
    group: 26

- name: Create Podman secret for PostgreSQL admin password
  containers.podman.podman_secret:
    name: postgresql_admin_password
    data: "{{ postgresql_admin_password }}"

- name: Deploy PostgreSQL container
  containers.podman.podman_container:
    name: "{{ postgresql_container_name }}"
    image: "{{ postgresql_container_image }}:{{ postgresql_container_tag }}"
    state: quadlet
    healthcheck: pg_isready
    sdnotify: healthy
    network: host
    volumes:
      - "{{ postgresql_data_dir }}:/var/lib/pgsql/data:Z"
    secrets:
      - 'postgresql_admin_password,target=POSTGRESQL_ADMIN_PASSWORD,type=env'
    env:
      REGISTRY_AUTH_FILE: "{{ postgresql_auth_file | default(omit) }}"
    quadlet_options:
      - |
        [Install]
        WantedBy=default.target

- name: Run daemon reload
  ansible.builtin.systemd:
    daemon_reload: true

- name: Start the PostgreSQL Service
  ansible.builtin.systemd:
    name: "{{ postgresql_container_name }}"
    enabled: true
    state: started

- name: Create PostgreSQL users
  community.postgresql.postgresql_user:
    name: "{{ item.name }}"
    password: "{{ item.password }}"
    login_user: postgres
    login_password: "{{ postgresql_admin_password }}"
    login_host: localhost
    state: present
  loop: "{{ postgresql_users }}"
  no_log: true

- name: Create PostgreSQL databases
  community.postgresql.postgresql_db:
    name: "{{ item.name }}"
    owner: "{{ item.owner }}"
    login_user: postgres
    login_password: "{{ postgresql_admin_password }}"
    login_host: localhost
    state: present
  loop: "{{ postgresql_databases }}"
