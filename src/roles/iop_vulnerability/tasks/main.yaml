---
- name: Create vulnerability database secrets
  containers.podman.podman_secret:
    name: "{{ item.name }}"
    data: "{{ item.data }}"
    state: present
  loop:
    - name: "iop-service-vulnerability-database-username"
      data: "{{ iop_vulnerability_database_user }}"
    - name: "iop-service-vulnerability-database-password"
      data: "{{ iop_vulnerability_database_password }}"
    - name: "iop-service-vulnerability-database-name"
      data: "{{ iop_vulnerability_database_name }}"
    - name: "iop-service-vulnerability-database-host"
      data: "{{ iop_vulnerability_database_host }}"
    - name: "iop-service-vulnerability-database-port"
      data: "{{ iop_vulnerability_database_port }}"
  no_log: true

- name: Set up Foreign Data Wrapper for vulnerability database
  ansible.builtin.include_role:
    name: iop_fdw
  vars:
    iop_fdw_database_name: "{{ iop_vulnerability_database_name }}"
    iop_fdw_database_user: "{{ iop_vulnerability_database_user }}"
    iop_fdw_database_password: "{{ iop_vulnerability_database_password }}"
    iop_fdw_remote_database_name: "{{ iop_inventory_database_name }}"
    iop_fdw_remote_user: "{{ iop_inventory_database_user }}"
    iop_fdw_remote_password: "{{ iop_inventory_database_password }}"

# 1. Database upgrade init container (oneshot)
- name: Deploy Vulnerability Database Upgrade container
  containers.podman.podman_container:
    name: iop-service-vuln-dbupgrade
    image: "{{ iop_vulnerability_container_image }}:{{ iop_vulnerability_container_tag }}"
    state: quadlet
    quadlet_dir: /etc/containers/systemd
    network: iop-core-network
    command: "bash -c /engine/dbupgrade.sh"
    env:
      UNLEASH_BOOTSTRAP_FILE: "develfeatureflags.json"
      DISABLE_RBAC: "TRUE"
      POSTGRES_SSL_MODE: "disable"
    secrets:
      - "iop-service-vulnerability-database-username,type=env,target=POSTGRES_USER"
      - "iop-service-vulnerability-database-password,type=env,target=POSTGRES_PASSWORD"
      - "iop-service-vulnerability-database-name,type=env,target=POSTGRES_DB"
      - "iop-service-vulnerability-database-host,type=env,target=POSTGRES_HOST"
      - "iop-service-vulnerability-database-port,type=env,target=POSTGRES_PORT"
    quadlet_options:
      - |
        [Unit]
        Description=Vulnerability Database Upgrade Init Container
        [Service]
        Type=oneshot
        RemainAfterExit=true
        Environment=REGISTRY_AUTH_FILE=/etc/foreman/registry-auth.json
        [Install]
        WantedBy=default.target
  notify: restart vulnerability

# 2. Manager service (main service)
- name: Deploy Vulnerability Manager container
  containers.podman.podman_container:
    name: iop-service-vuln-manager
    image: "{{ iop_vulnerability_container_image }}:{{ iop_vulnerability_container_tag }}"
    state: quadlet
    quadlet_dir: /etc/containers/systemd
    network: iop-core-network
    command: "/engine/entrypoint.sh manager"
    env:
      UNLEASH_BOOTSTRAP_FILE: "develfeatureflags.json"
      DISABLE_RBAC: "TRUE"
      POSTGRES_SSL_MODE: "disable"
    secrets:
      - "iop-service-vulnerability-database-username,type=env,target=POSTGRES_USER"
      - "iop-service-vulnerability-database-password,type=env,target=POSTGRES_PASSWORD"
      - "iop-service-vulnerability-database-name,type=env,target=POSTGRES_DB"
      - "iop-service-vulnerability-database-host,type=env,target=POSTGRES_HOST"
      - "iop-service-vulnerability-database-port,type=env,target=POSTGRES_PORT"
    quadlet_options:
      - |
        [Unit]
        Description=Vulnerability Manager Service
        After=network-online.target iop-service-vuln-dbupgrade.service
        Requires=iop-service-vuln-dbupgrade.service
        [Service]
        Restart=on-failure
        Environment=REGISTRY_AUTH_FILE=/etc/foreman/registry-auth.json
        [Install]
        WantedBy=default.target
  notify: restart vulnerability

# 3. Taskomatic service (task scheduler)
- name: Deploy Vulnerability Taskomatic container
  containers.podman.podman_container:
    name: iop-service-vuln-taskomatic
    image: "{{ iop_vulnerability_container_image }}:{{ iop_vulnerability_container_tag }}"
    state: quadlet
    quadlet_dir: /etc/containers/systemd
    network: iop-core-network
    command: "/engine/entrypoint.sh taskomatic"
    env:
      UNLEASH_BOOTSTRAP_FILE: "develfeatureflags.json"
      IS_FEDRAMP: "true"
      JOBS: "{{ iop_vulnerability_taskomatic_jobs }}"
      JOBS_STARTUP: "{{ iop_vulnerability_taskomatic_startup }}"
      POSTGRES_SSL_MODE: "disable"
    secrets:
      - "iop-service-vulnerability-database-username,type=env,target=POSTGRES_USER"
      - "iop-service-vulnerability-database-password,type=env,target=POSTGRES_PASSWORD"
      - "iop-service-vulnerability-database-name,type=env,target=POSTGRES_DB"
      - "iop-service-vulnerability-database-host,type=env,target=POSTGRES_HOST"
      - "iop-service-vulnerability-database-port,type=env,target=POSTGRES_PORT"
    quadlet_options:
      - |
        [Unit]
        Description=Vulnerability Taskomatic Service
        Wants=iop-service-vuln-manager.service
        After=iop-service-vuln-manager.service
        [Service]
        Restart=on-failure
        Environment=REGISTRY_AUTH_FILE=/etc/foreman/registry-auth.json
        [Install]
        WantedBy=default.target
  notify: restart vulnerability

# 4. Grouper service
- name: Deploy Vulnerability Grouper container
  containers.podman.podman_container:
    name: iop-service-vuln-grouper
    image: "{{ iop_vulnerability_container_image }}:{{ iop_vulnerability_container_tag }}"
    state: quadlet
    quadlet_dir: /etc/containers/systemd
    network: iop-core-network
    command: "/engine/entrypoint.sh grouper"
    env:
      UNLEASH_BOOTSTRAP_FILE: "develfeatureflags.json"
      KAFKA_HOST: "iop-core-kafka"
      KAFKA_PORT: "9092"
      KAFKA_GROUP_ID: "vulnerability-grouper"
      PAYLOAD_TRACKER_TOPIC: "platform.payload-status"
      GROUPER_INVENTORY_TOPIC: "vulnerability.grouper.inventory.upload"
      GROUPER_ADVISOR_TOPIC: "vulnerability.grouper.advisor.upload"
      PROMETHEUS_PORT: "8085"
      POSTGRES_SSL_MODE: "disable"
    secrets:
      - "iop-service-vulnerability-database-username,type=env,target=POSTGRES_USER"
      - "iop-service-vulnerability-database-password,type=env,target=POSTGRES_PASSWORD"
      - "iop-service-vulnerability-database-name,type=env,target=POSTGRES_DB"
      - "iop-service-vulnerability-database-host,type=env,target=POSTGRES_HOST"
      - "iop-service-vulnerability-database-port,type=env,target=POSTGRES_PORT"
    quadlet_options:
      - |
        [Unit]
        Description=Vulnerability Grouper Service
        Wants=iop-service-vuln-manager.service
        After=iop-service-vuln-manager.service
        [Service]
        Restart=on-failure
        Environment=REGISTRY_AUTH_FILE=/etc/foreman/registry-auth.json
        [Install]
        WantedBy=default.target
  notify: restart vulnerability

# 5. Listener service (event listener)
- name: Deploy Vulnerability Listener container
  containers.podman.podman_container:
    name: iop-service-vuln-listener
    image: "{{ iop_vulnerability_container_image }}:{{ iop_vulnerability_container_tag }}"
    state: quadlet
    quadlet_dir: /etc/containers/systemd
    network: iop-core-network
    command: "/engine/entrypoint.sh listener"
    env:
      UNLEASH_BOOTSTRAP_FILE: "develfeatureflags.json"
      KAFKA_HOST: "iop-core-kafka"
      KAFKA_PORT: "9092"
      KAFKA_GROUP_ID: "vulnerability-listener2"
      EVENTS_TOPIC: "platform.inventory.events"
      PAYLOAD_TRACKER_TOPIC: "platform.payload-status"
      ADVISOR_RESULTS_TOPIC: "platform.engine.results"
      MESSAGE_TOPIC: "vulnerability.evaluator.upload"
      ALLOWED_REPORTERS: "puptoo,satellite"
    secrets:
      - "iop-service-vulnerability-database-username,type=env,target=POSTGRES_USER"
      - "iop-service-vulnerability-database-password,type=env,target=POSTGRES_PASSWORD"
      - "iop-service-vulnerability-database-name,type=env,target=POSTGRES_DB"
      - "iop-service-vulnerability-database-host,type=env,target=POSTGRES_HOST"
      - "iop-service-vulnerability-database-port,type=env,target=POSTGRES_PORT"
    quadlet_options:
      - |
        [Unit]
        Description=Vulnerability Listener Service
        Wants=iop-service-vuln-manager.service
        After=iop-service-vuln-manager.service
        [Service]
        Restart=on-failure
        Environment=REGISTRY_AUTH_FILE=/etc/foreman/registry-auth.json
        [Install]
        WantedBy=default.target
  notify: restart vulnerability

# 6. Evaluator (Recalc) service
- name: Deploy Vulnerability Evaluator (Recalc) container
  containers.podman.podman_container:
    name: iop-service-vuln-evaluator-recalc
    image: "{{ iop_vulnerability_container_image }}:{{ iop_vulnerability_container_tag }}"
    state: quadlet
    quadlet_dir: /etc/containers/systemd
    network: iop-core-network
    command: "/engine/entrypoint.sh evaluator"
    env:
      UNLEASH_BOOTSTRAP_FILE: "develfeatureflags.json"
      KAFKA_HOST: "iop-core-kafka"
      KAFKA_PORT: "9092"
      KAFKA_GROUP_ID: "vulnerability"
      PAYLOAD_TRACKER_TOPIC: "platform.payload-status"
      REMEDIATION_UPDATES_TOPIC: "platform.remediation-updates.vulnerability"
      EVALUATOR_RESULTS_TOPIC: "vulnerability.evaluator.results"
      EVALUATOR_TOPIC: "vulnerability.evaluator.recalc"
      VMAAS_HOST: "http://iop-service-vmaas-webapp-go:8000"
    secrets:
      - "iop-service-vulnerability-database-username,type=env,target=POSTGRES_USER"
      - "iop-service-vulnerability-database-password,type=env,target=POSTGRES_PASSWORD"
      - "iop-service-vulnerability-database-name,type=env,target=POSTGRES_DB"
      - "iop-service-vulnerability-database-host,type=env,target=POSTGRES_HOST"
      - "iop-service-vulnerability-database-port,type=env,target=POSTGRES_PORT"
    quadlet_options:
      - |
        [Unit]
        Description=Vulnerability Evaluator (Recalc) Service
        Wants=iop-service-vuln-manager.service
        After=iop-service-vuln-manager.service
        [Service]
        Restart=on-failure
        Environment=REGISTRY_AUTH_FILE=/etc/foreman/registry-auth.json
        [Install]
        WantedBy=default.target
  notify: restart vulnerability

# 7. Evaluator (Upload) service
- name: Deploy Vulnerability Evaluator (Upload) container
  containers.podman.podman_container:
    name: iop-service-vuln-evaluator-upload
    image: "{{ iop_vulnerability_container_image }}:{{ iop_vulnerability_container_tag }}"
    state: quadlet
    quadlet_dir: /etc/containers/systemd
    network: iop-core-network
    command: "/engine/entrypoint.sh evaluator"
    env:
      UNLEASH_BOOTSTRAP_FILE: "develfeatureflags.json"
      KAFKA_HOST: "iop-core-kafka"
      KAFKA_PORT: "9092"
      KAFKA_GROUP_ID: "vulnerability"
      PAYLOAD_TRACKER_TOPIC: "platform.payload-status"
      REMEDIATION_UPDATES_TOPIC: "platform.remediation-updates.vulnerability"
      EVALUATOR_RESULTS_TOPIC: "vulnerability.evaluator.results"
      EVALUATOR_TOPIC: "vulnerability.evaluator.upload"
      VMAAS_HOST: "http://iop-service-vmaas-webapp-go:8000"
    secrets:
      - "iop-service-vulnerability-database-username,type=env,target=POSTGRES_USER"
      - "iop-service-vulnerability-database-password,type=env,target=POSTGRES_PASSWORD"
      - "iop-service-vulnerability-database-name,type=env,target=POSTGRES_DB"
      - "iop-service-vulnerability-database-host,type=env,target=POSTGRES_HOST"
      - "iop-service-vulnerability-database-port,type=env,target=POSTGRES_PORT"
    quadlet_options:
      - |
        [Unit]
        Description=Vulnerability Evaluator (Upload) Service
        Wants=iop-service-vuln-grouper.service iop-service-vuln-manager.service
        After=iop-service-vuln-grouper.service iop-service-vuln-manager.service
        [Service]
        Restart=on-failure
        Environment=REGISTRY_AUTH_FILE=/etc/foreman/registry-auth.json
        [Install]
        WantedBy=default.target
  notify: restart vulnerability

# 8. VMAAS Sync service (oneshot with timer)
- name: Deploy Vulnerability VMAAS Sync container
  containers.podman.podman_container:
    name: iop-service-vuln-vmaas-sync
    image: "{{ iop_vulnerability_container_image }}:{{ iop_vulnerability_container_tag }}"
    state: quadlet
    quadlet_dir: /etc/containers/systemd
    network: iop-core-network
    command: "/engine/entrypoint.sh vmaas-sync"
    env:
      UNLEASH_BOOTSTRAP_FILE: "develfeatureflags.json"
      KAFKA_HOST: "iop-core-kafka"
      KAFKA_PORT: "9092"
      KAFKA_GROUP_ID: "vulnerability"
      MESSAGE_TOPIC: "vulnerability.evaluator.recalc"
      VMAAS_HOST: "http://iop-service-vmaas-webapp-go:8000"
    secrets:
      - "iop-service-vulnerability-database-username,type=env,target=POSTGRES_USER"
      - "iop-service-vulnerability-database-password,type=env,target=POSTGRES_PASSWORD"
      - "iop-service-vulnerability-database-name,type=env,target=POSTGRES_DB"
      - "iop-service-vulnerability-database-host,type=env,target=POSTGRES_HOST"
      - "iop-service-vulnerability-database-port,type=env,target=POSTGRES_PORT"
    quadlet_options:
      - |
        [Unit]
        Description=Vulnerability VMAAS Sync Job
        Wants=iop-service-vmaas-webapp-go.service iop-service-vuln-manager.service
        After=iop-service-vmaas-webapp-go.service iop-service-vuln-manager.service
        [Service]
        Type=oneshot
        Environment=REGISTRY_AUTH_FILE=/etc/foreman/registry-auth.json
  notify: restart vulnerability

- name: Create VMAAS Sync systemd timer
  ansible.builtin.copy:
    dest: /etc/systemd/system/iop-service-vuln-vmaas-sync.timer
    content: |
      [Unit]
      Description=Vulnerability VMAAS Sync Timer

      [Timer]
      OnCalendar=daily
      RandomizedDelaySec=1h
      Persistent=true

      [Install]
      WantedBy=timers.target
    mode: '0644'

- name: Run daemon reload to make Quadlet create the service files
  ansible.builtin.systemd:
    daemon_reload: true

- name: Start Vulnerability Database Upgrade service
  ansible.builtin.systemd:
    name: iop-service-vuln-dbupgrade
    enabled: true
    state: started

- name: Start Vulnerability Manager service
  ansible.builtin.systemd:
    name: iop-service-vuln-manager
    enabled: true
    state: started

- name: Start Vulnerability Taskomatic service
  ansible.builtin.systemd:
    name: iop-service-vuln-taskomatic
    enabled: true
    state: started

- name: Start Vulnerability Grouper service
  ansible.builtin.systemd:
    name: iop-service-vuln-grouper
    enabled: true
    state: started

- name: Start Vulnerability Listener service
  ansible.builtin.systemd:
    name: iop-service-vuln-listener
    enabled: true
    state: started

- name: Start Vulnerability Evaluator (Recalc) service
  ansible.builtin.systemd:
    name: iop-service-vuln-evaluator-recalc
    enabled: true
    state: started

- name: Start Vulnerability Evaluator (Upload) service
  ansible.builtin.systemd:
    name: iop-service-vuln-evaluator-upload
    enabled: true
    state: started

- name: Enable VMAAS Sync timer
  ansible.builtin.systemd:
    name: iop-service-vuln-vmaas-sync.timer
    enabled: true
    state: started
