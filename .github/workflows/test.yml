---
name: Test

on:
  push:
    branches:
      - master
    paths-ignore:
      - 'docs/**'
  pull_request:
    paths-ignore:
      - 'docs/**'


concurrency:
  group: ${{ github.ref_name }}-${{ github.workflow }}
  cancel-in-progress: true

jobs:
  tests:
    strategy:
      fail-fast: false
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v5
      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.12'
      - name: Setup libvirt for Vagrant
        uses: voxpupuli/setup-vagrant@v0
      - name: Install systemd-resolved
        run: |
          sudo apt-get install -y --no-install-recommends systemd-resolved
      - name: Install DNS hook
        run: |
          # https://gist.github.com/ekohl/e487422d4aaad8ab176c19ec713b700a
          sudo curl -L https://gist.github.com/ekohl/e487422d4aaad8ab176c19ec713b700a/raw/d0792cf733b5ffb65873cc33c96e7a1b54e0d14b/network.py -o /etc/libvirt/hooks/network
          sudo chmod 0755 /etc/libvirt/hooks/network
          sudo systemctl restart libvirtd
      - name: Start VMs
        run: |
          vagrant up --no-provision --no-tty quadlet
      - name: Ping machine
        run: |
          resolvectl
          ping -c1 quadlet.example.com
      - name: Setup upterm session
        if: ${{ failure() }}
        uses: owenthereal/action-upterm@v1
        with:
          ## limits ssh access and adds the ssh public key for the user which triggered the workflow
          limit-access-to-actor: true
          ## If no one connects after 5 minutes, shut down server.
          wait-timeout-minutes: 5
