import pytest


def test_vulnerability_manager_service(server):
    service = server.service("iop-service-vuln-manager")
    assert service.is_running
    assert service.is_enabled


def test_vulnerability_dbupgrade_service(server):
    service = server.service("iop-service-vuln-dbupgrade")
    assert service.is_enabled


def test_vulnerability_taskomatic_service(server):
    service = server.service("iop-service-vuln-taskomatic")
    assert service.is_running
    assert service.is_enabled


def test_vulnerability_grouper_service(server):
    service = server.service("iop-service-vuln-grouper")
    assert service.is_running
    assert service.is_enabled


def test_vulnerability_listener_service(server):
    service = server.service("iop-service-vuln-listener")
    assert service.is_running
    assert service.is_enabled


def test_vulnerability_evaluator_recalc_service(server):
    service = server.service("iop-service-vuln-evaluator-recalc")
    assert service.is_running
    assert service.is_enabled


def test_vulnerability_evaluator_upload_service(server):
    service = server.service("iop-service-vuln-evaluator-upload")
    assert service.is_running
    assert service.is_enabled


def test_vulnerability_vmaas_sync_timer(server):
    timer = server.service("iop-service-vuln-vmaas-sync.timer")
    assert timer.is_enabled


def test_vulnerability_quadlet_files(server):
    containers = [
        "iop-service-vuln-dbupgrade",
        "iop-service-vuln-manager",
        "iop-service-vuln-taskomatic",
        "iop-service-vuln-grouper",
        "iop-service-vuln-listener",
        "iop-service-vuln-evaluator-recalc",
        "iop-service-vuln-evaluator-upload",
        "iop-service-vuln-vmaas-sync",
    ]
    for container in containers:
        quadlet_file = server.file(f"/etc/containers/systemd/{container}.container")
        assert quadlet_file.exists
        assert quadlet_file.is_file


def test_vulnerability_database_secrets(server):
    result = server.run("podman secret ls --format '{{.Name}}'")
    assert result.succeeded
    assert "iop-service-vulnerability-database-username" in result.stdout
    assert "iop-service-vulnerability-database-password" in result.stdout
    assert "iop-service-vulnerability-database-name" in result.stdout
    assert "iop-service-vulnerability-database-host" in result.stdout
    assert "iop-service-vulnerability-database-port" in result.stdout


def test_vulnerability_containers_networking(server):
    containers = [
        "iop-service-vuln-manager",
        "iop-service-vuln-taskomatic",
        "iop-service-vuln-grouper",
        "iop-service-vuln-listener",
        "iop-service-vuln-evaluator-recalc",
        "iop-service-vuln-evaluator-upload",
    ]
    for container in containers:
        result = server.run(f"podman inspect {container} --format '{{{{.NetworkSettings.Networks}}}}'")
        assert result.succeeded
        assert "iop-core-network" in result.stdout


def test_vulnerability_manager_environment_variables(server):
    result = server.run("podman inspect iop-service-vuln-manager --format '{{.Config.Env}}'")
    assert result.succeeded
    assert "UNLEASH_BOOTSTRAP_FILE=develfeatureflags.json" in result.stdout
    assert "DISABLE_RBAC=TRUE" in result.stdout


def test_vulnerability_taskomatic_environment_variables(server):
    result = server.run("podman inspect iop-service-vuln-taskomatic --format '{{.Config.Env}}'")
    assert result.succeeded
    assert "IS_FEDRAMP=true" in result.stdout
    assert "JOBS=stale_systems:5,delete_systems:30,cacheman:5" in result.stdout
    assert "JOBS_STARTUP=cacheman" in result.stdout


def test_vulnerability_grouper_environment_variables(server):
    result = server.run("podman inspect iop-service-vuln-grouper --format '{{.Config.Env}}'")
    assert result.succeeded
    assert "KAFKA_HOST=iop-core-kafka" in result.stdout
    assert "KAFKA_PORT=9092" in result.stdout
    assert "KAFKA_GROUP_ID=vulnerability-grouper" in result.stdout
    assert "PROMETHEUS_PORT=8085" in result.stdout


def test_vulnerability_listener_environment_variables(server):
    result = server.run("podman inspect iop-service-vuln-listener --format '{{.Config.Env}}'")
    assert result.succeeded
    assert "KAFKA_GROUP_ID=vulnerability-listener2" in result.stdout
    assert "EVENTS_TOPIC=platform.inventory.events" in result.stdout
    assert "ALLOWED_REPORTERS=puptoo,satellite" in result.stdout


def test_vulnerability_evaluator_recalc_environment_variables(server):
    result = server.run("podman inspect iop-service-vuln-evaluator-recalc --format '{{.Config.Env}}'")
    assert result.succeeded
    assert "EVALUATOR_TOPIC=vulnerability.evaluator.recalc" in result.stdout
    assert "VMAAS_HOST=http://iop-service-vmaas-webapp-go:8000" in result.stdout


def test_vulnerability_evaluator_upload_environment_variables(server):
    result = server.run("podman inspect iop-service-vuln-evaluator-upload --format '{{.Config.Env}}'")
    assert result.succeeded
    assert "EVALUATOR_TOPIC=vulnerability.evaluator.upload" in result.stdout
    assert "VMAAS_HOST=http://iop-service-vmaas-webapp-go:8000" in result.stdout


def test_vulnerability_container_commands(server):
    containers_commands = {
        "iop-service-vuln-dbupgrade": ["bash", "-c", "/engine/dbupgrade.sh"],
        "iop-service-vuln-manager": ["/engine/entrypoint.sh", "manager"],
        "iop-service-vuln-taskomatic": ["/engine/entrypoint.sh", "taskomatic"],
        "iop-service-vuln-grouper": ["/engine/entrypoint.sh", "grouper"],
        "iop-service-vuln-listener": ["/engine/entrypoint.sh", "listener"],
        "iop-service-vuln-evaluator-recalc": ["/engine/entrypoint.sh", "evaluator"],
        "iop-service-vuln-evaluator-upload": ["/engine/entrypoint.sh", "evaluator"],
    }
    for container, expected_cmd in containers_commands.items():
        result = server.run(f"podman inspect {container} --format '{{{{.Config.Cmd}}}}'")
        if result.succeeded:
            for cmd_part in expected_cmd:
                assert cmd_part in result.stdout


def test_vulnerability_timer_file(server):
    timer_file = server.file("/etc/systemd/system/iop-service-vuln-vmaas-sync.timer")
    assert timer_file.exists
    assert timer_file.is_file
    assert "OnCalendar=daily" in timer_file.content.decode()


def test_vulnerability_fdw_foreign_server_exists(server):
    result = server.run("podman exec postgresql psql vulnerability_db -c \"SELECT * FROM pg_foreign_server WHERE srvname = 'hbi_server';\"")
    assert result.succeeded
    assert "hbi_server" in result.stdout


def test_vulnerability_fdw_user_mapping_exists(server):
    result = server.run("podman exec postgresql psql vulnerability_db -c \"SELECT * FROM pg_user_mappings WHERE srvname = 'hbi_server' AND usename = 'vulnerability_admin';\"")
    assert result.succeeded
    assert "vulnerability_admin" in result.stdout


def test_vulnerability_fdw_foreign_table_exists(server):
    result = server.run("podman exec postgresql psql vulnerability_db -c \"SELECT * FROM information_schema.foreign_tables WHERE foreign_table_schema = 'inventory_remote' AND foreign_table_name = 'hosts';\"")
    assert result.succeeded
    assert "hosts" in result.stdout


def test_vulnerability_fdw_view_exists(server):
    result = server.run("podman exec postgresql psql vulnerability_db -c \"SELECT * FROM information_schema.views WHERE table_schema = 'inventory' AND table_name = 'hosts';\"")
    assert result.succeeded
    assert "hosts" in result.stdout


def test_vulnerability_fdw_view_access(server):
    result = server.run("podman exec postgresql psql vulnerability_db -c \"SELECT COUNT(*) FROM inventory.hosts;\"")
    assert "permission denied" not in result.stdout.lower()
    assert "does not exist" not in result.stdout.lower()
